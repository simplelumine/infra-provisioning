*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]

# 1. Allow Loopback interface
-A INPUT -i lo -j ACCEPT

# 2. Allow Established and Related connections
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# 3. Allow ICMP (Ping)
-A INPUT -p icmp -j ACCEPT

# 4. Allow SSH (Port 22)
-A INPUT -p tcp --dport 22 -j ACCEPT

# 5. Allow Ingress Traffic (80, 443) - Global Public
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -p tcp --dport 443 -j ACCEPT

# 6. Allow NodePorts (30000-32767) - Global Public
# Required for services exposed via NodePort if not using Ingress.
-A INPUT -p tcp --dport 30000:32767 -j ACCEPT
-A INPUT -p udp --dport 30000:32767 -j ACCEPT

# 7. Trust Cluster Peers (Internal Traffic)
# Uses 'peer_group' variable (e.g. prod_cluster, lab_cluster)
# Covers: VXLAN (8472), WireGuard (51871), Health (4240), Kubelet (10250)
{% if peer_group is defined %}
  {% for host in groups[peer_group] %}
    {% if hostvars[host]['ansible_host'] is defined and host != inventory_hostname %}
-A INPUT -s {{ hostvars[host]['ansible_host'] }} -j ACCEPT
    {% endif %}
  {% endfor %}
{% endif %}

COMMIT
