# --- Swap Configuration ---
- name: Calculate Swap Size
  set_fact:
    swap_size_mb: "{{ 1024 if ansible_memtotal_mb < 1024 else ansible_memtotal_mb }}"

- name: Check if swap file exists
  stat:
    path: /swapfile
  register: swap_file

- name: Create swap file
  command: dd if=/dev/zero of=/swapfile bs=1M count={{ swap_size_mb }}
  when: not swap_file.stat.exists

- name: Set swap file permissions
  file:
    path: /swapfile
    mode: '0600'

- name: Format swap file
  command: mkswap /swapfile
  when: not swap_file.stat.exists

- name: Enable swap
  command: swapon /swapfile
  when: not swap_file.stat.exists

- name: Persist swap in fstab
  mount:
    path: none
    src: /swapfile
    fstype: swap
    opts: sw
    state: present

- name: Tune Swappiness
  sysctl:
    name: vm.swappiness
    value: '60'
    state: present
