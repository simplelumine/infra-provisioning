---
# Install Tailscale using official install script (auto-detects distro)
- name: Install Tailscale
  shell: |
    curl -fsSL https://tailscale.com/install.sh | sh
  args:
    creates: /usr/bin/tailscale

# Enable IP forwarding for Exit Node / Subnet Router functionality
- name: Enable IPv4 and IPv6 forwarding for Tailscale
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/99-tailscale.conf
    sysctl_set: true
    state: present
    reload: true
  loop:
    - { name: 'net.ipv4.ip_forward', value: '1' }
    - { name: 'net.ipv6.conf.all.forwarding', value: '1' }

- name: Enable Tailscale service
  service:
    name: tailscaled
    state: started
    enabled: true

# Check current Tailscale status before attempting authentication
- name: Check Tailscale Status
  command: tailscale status --json
  register: ts_status
  failed_when: false
  changed_when: false

# Only authenticate if not already connected
- name: Authenticate Tailscale
  command: tailscale up --authkey={{ tailscale_auth_key }}
  when: >
    tailscale_auth_key is defined and
    tailscale_auth_key | length > 0 and
    (ts_status.rc != 0 or
     (ts_status.stdout | from_json).BackendState != 'Running')
  register: tailscale_up
  changed_when: tailscale_up.rc == 0

# Advertise as Exit Node
- name: Advertise as Exit Node
  command: tailscale set --advertise-exit-node
  register: exit_node_result
  changed_when: exit_node_result.rc == 0
  failed_when: false
