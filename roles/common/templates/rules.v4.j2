*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]

# 1. Allow Loopback interface
-A INPUT -i lo -j ACCEPT

# 2. Allow Established and Related connections
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# 3. Allow ICMP (Ping)
-A INPUT -p icmp -j ACCEPT

# 4. Allow SSH (Port 22)
-A INPUT -p tcp --dport 22 -j ACCEPT

# 5. Allow Tailscale Interface (Trusted Management / Overlay)
# Only applies if Tailscale is configured (checked by auth key presence)
{% if tailscale_auth_key is defined %}
-A INPUT -i tailscale0 -j ACCEPT
{% endif %}

# 6. Allow Global Web Traffic (HTTP/HTTPS) - For Edge Proxy or Host Services
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -p tcp --dport 443 -j ACCEPT

# 7. Cluster Trust Zone (Only for Cluster Nodes)
# Cluster nodes must trust Edge nodes (for Ingress) and other Cluster nodes (for Etcd/VXLAN)
{% if 'prod_cluster' in group_names or 'lab_cluster' in group_names %}
# Trust all nodes in the inventory
  {% for host in groups['all'] %}
    {% if hostvars[host]['ansible_host'] is defined and host != inventory_hostname %}
-A INPUT -s {{ hostvars[host]['ansible_host'] }} -j ACCEPT
    {% endif %}
  {% endfor %}

# Allow NodePorts (Service Exposure)
-A INPUT -p tcp --dport 30000:32767 -j ACCEPT
-A INPUT -p udp --dport 30000:32767 -j ACCEPT
{% endif %}

# 8. Dynamic Xray Port (If defined)
{% if xray_port_tcp is defined %}
-A INPUT -p tcp --dport {{ xray_port_tcp }} -j ACCEPT
{% endif %}

COMMIT
