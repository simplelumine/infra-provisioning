*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]

# 1. Allow Loopback interface
-A INPUT -i lo -j ACCEPT

# 2. Allow Established and Related connections
-A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# 3. Allow ICMP (Ping)
-A INPUT -p icmp -j ACCEPT

# 4. Allow SSH (Port 22)
# Tailscale / Bastion Access usually handles this, but we need 22 for Ansible
-A INPUT -p tcp --dport 22 -j ACCEPT

# 5. Allow Tailscale Overlay (UDP 41641)
-A INPUT -p udp --dport 41641 -j ACCEPT
# Allow traffic from Tailscale interface (tailscale0)
-A INPUT -i tailscale0 -j ACCEPT

# 6. Allow Kubernetes Mesh Traffic (Only from Cluster Peers)
{% if groups['k3s_cluster'] is defined and inventory_hostname in groups['k3s_cluster'] %}
# Allow API (6443), WireGuard (51871), VXLAN (8472), Hubble (4240), Metrics, etc.
# We trust our peer nodes entirely on the private mesh.
  {% for host in groups['k3s_cluster'] %}
    {% if hostvars[host]['ansible_host'] is defined %}
-A INPUT -s {{ hostvars[host]['ansible_host'] }} -j ACCEPT
    {% endif %}
  {% endfor %}
{% endif %}

# 7. Allow Xray (Dynamic: Applies if xray_port_tcp is defined)
{% if xray_port_tcp is defined %}
-A INPUT -p tcp --dport {{ xray_port_tcp }} -j ACCEPT
{% endif %}

# 8. Allow K8s Ingress (Workers Only: 80/443)
{% if 'prod_worker_nodes' in group_names or 'lab_worker_nodes' in group_names %}
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -p tcp --dport 443 -j ACCEPT
{% endif %}

COMMIT
